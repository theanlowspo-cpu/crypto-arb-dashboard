<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸŸ é–‹å¿ƒå¥—åˆ©å°å»šæˆ¿</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg, #FFF3CD 0%, #FFECB3 50%, #FFE082 100%);
  min-height: 100vh;
  color: #333;
}

/* é ‚éƒ¨æ©«å¹… */
.header {
  background: linear-gradient(90deg, #DA291C, #FF5722, #DA291C);
  color: white;
  padding: 20px;
  text-align: center;
  box-shadow: 0 4px 15px rgba(218,41,28,0.3);
  position: relative;
  overflow: hidden;
}
.header h1 { font-size: 2em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
.header .subtitle { font-size: 1.1em; opacity: 0.9; margin-top: 5px; }
.header .mascot {
  position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
  width: 80px; height: 80px; border-radius: 50%; border: 3px solid #FFC107;
  object-fit: cover;
}
.header .mascot-left {
  position: absolute; left: 20px; top: 50%; transform: translateY(-50%);
  width: 80px; height: 80px; border-radius: 50%; border: 3px solid #FFC107;
  object-fit: cover;
}

/* ç‹€æ…‹åˆ— */
.status-bar {
  background: #FFC107;
  padding: 10px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: bold;
  color: #333;
  flex-wrap: wrap;
  gap: 10px;
}
.status-item { display: flex; align-items: center; gap: 5px; }
.status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
.dot-green { background: #4CAF50; box-shadow: 0 0 8px #4CAF50; }
.dot-red { background: #f44336; box-shadow: 0 0 8px #f44336; }

/* ä¸»å…§å®¹ */
.container { max-width: 1200px; margin: 0 auto; padding: 20px; }

/* ç¸½è¦½å¡ç‰‡ */
.summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}
.card {
  background: white;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  text-align: center;
  border-top: 4px solid #FFC107;
  transition: transform 0.2s;
}
.card:hover { transform: translateY(-3px); }
.card .emoji { font-size: 2em; }
.card .label { color: #888; font-size: 0.85em; margin-top: 5px; }
.card .value { font-size: 1.8em; font-weight: bold; margin-top: 5px; }
.card .value.profit { color: #4CAF50; }
.card .value.loss { color: #f44336; }

/* æŒå€‰å€ */
.section-title {
  font-size: 1.4em;
  color: #DA291C;
  margin: 25px 0 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.positions-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}
.position-card {
  background: white;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  border-left: 5px solid #FFC107;
}
.position-card .symbol {
  font-size: 1.3em;
  font-weight: bold;
  color: #DA291C;
}
.position-card .details {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-top: 12px;
  font-size: 0.9em;
}
.position-card .detail-label { color: #888; }
.position-card .detail-value { font-weight: bold; text-align: right; }
.position-card .pnl-bar {
  margin-top: 12px;
  height: 8px;
  background: #eee;
  border-radius: 4px;
  overflow: hidden;
}
.position-card .pnl-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.5s;
}
.pnl-positive { background: linear-gradient(90deg, #4CAF50, #8BC34A); }
.pnl-negative { background: linear-gradient(90deg, #f44336, #FF5722); }

/* æ­·å²äº¤æ˜“ */
.history-table {
  width: 100%;
  background: white;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  margin-bottom: 20px;
}
.history-table table { width: 100%; border-collapse: collapse; }
.history-table th {
  background: #DA291C;
  color: white;
  padding: 12px 15px;
  text-align: left;
  font-size: 0.9em;
}
.history-table td {
  padding: 10px 15px;
  border-bottom: 1px solid #f0f0f0;
  font-size: 0.85em;
}
.history-table tr:hover { background: #FFF8E1; }

/* å¯æ„›è£é£¾åœ– */
.cute-section {
  text-align: center;
  padding: 20px;
}
.cute-section img {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 4px solid #FFC107;
  margin: 0 10px;
  box-shadow: 0 4px 15px rgba(255,193,7,0.3);
}

/* è²»ç‡æ’è¡Œ */
.rate-list {
  background: white;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  margin-bottom: 20px;
}
.rate-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid #f5f5f5;
}
.rate-item:last-child { border-bottom: none; }
.rate-badge {
  background: #FFC107;
  color: #333;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.8em;
  font-weight: bold;
}

/* Footer */
.footer {
  text-align: center;
  padding: 20px;
  color: #888;
  font-size: 0.85em;
}
.footer .love { color: #DA291C; }

/* å‹•ç•« */
@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}
.floating { animation: float 3s ease-in-out infinite; }

/* æ‰‹æ©Ÿé©é… */
@media (max-width: 600px) {
  .header h1 { font-size: 1.4em; }
  .header .mascot, .header .mascot-left { display: none; }
  .summary-cards { grid-template-columns: repeat(2, 1fr); }
  .positions-grid { grid-template-columns: 1fr; }
  .card .value { font-size: 1.4em; }
}
</style>
</head>
<body>

<div class="header">
  <img src="img/burger_thief1.jpg" class="mascot-left" alt="æ¼¢å ¡ç¥å·">
  <h1>ğŸŸ é–‹å¿ƒå¥—åˆ©å°å»šæˆ¿ ğŸ”</h1>
  <div class="subtitle">è‡ªå‹•å¹«ä½ è³ºé›¶ç”¨éŒ¢çš„å¿«æ¨‚æ©Ÿå™¨ ğŸ’°</div>
  <img src="img/fries1.jpg" class="mascot" alt="è–¯æ¢å¯¶å¯¶">
</div>

<div class="status-bar">
  <div class="status-item">
    <span class="status-dot dot-green" id="statusDot"></span>
    <span id="statusText">ç³»çµ±é‹è¡Œä¸­</span>
  </div>
  <div class="status-item">ğŸ• æ›´æ–°: <span id="lastUpdate">è¼‰å…¥ä¸­...</span></div>
  <div class="status-item">â±ï¸ ä¸‹æ¬¡çµç®—: <span id="nextSettlement">è¨ˆç®—ä¸­...</span></div>
</div>

<div class="container">
  <!-- ç¸½è¦½å¡ç‰‡ -->
  <div class="summary-cards">
    <div class="card">
      <div class="emoji">ğŸ’°</div>
      <div class="label">ç´¯è¨ˆç›ˆè™§</div>
      <div class="value" id="totalPnl">$0.00</div>
    </div>
    <div class="card">
      <div class="emoji">ğŸ“Š</div>
      <div class="label">ç•¶å‰æŒå€‰</div>
      <div class="value" id="posCount">0/3</div>
    </div>
    <div class="card">
      <div class="emoji">ğŸ¯</div>
      <div class="label">äº¤æ˜“æ¬¡æ•¸</div>
      <div class="value" id="tradeCount">0</div>
    </div>
    <div class="card">
      <div class="emoji">ğŸ†</div>
      <div class="label">å‹ç‡</div>
      <div class="value" id="winRate">--%</div>
    </div>
    <div class="card">
      <div class="emoji">ğŸ’µ</div>
      <div class="label">å¸³æˆ¶é¤˜é¡</div>
      <div class="value" id="balance">$0.00</div>
    </div>
    <div class="card">
      <div class="emoji">ğŸ“ˆ</div>
      <div class="label">æœªå¯¦ç¾ç›ˆè™§</div>
      <div class="value" id="unrealizedPnl">$0.00</div>
    </div>
  </div>

  <!-- ç•¶å‰æŒå€‰ -->
  <div class="section-title">ğŸŸ ç•¶å‰æŒå€‰</div>
  <div class="positions-grid" id="positionsGrid">
    <div class="position-card"><p style="text-align:center;color:#888;">è¼‰å…¥ä¸­...</p></div>
  </div>

  <!-- å¯æ„›è£é£¾ -->
  <div class="cute-section">
    <img src="img/hamster1.jpg" class="floating" alt="å€‰é¼ å¯¶å¯¶" title="å€‰é¼ å¯¶å¯¶">
    <img src="img/milkshake1.jpg" class="floating" style="animation-delay:0.5s" alt="å¥¶æ˜”å¤§å“¥" title="å¥¶æ˜”å¤§å“¥">
    <img src="img/burger_thief2.jpg" class="floating" style="animation-delay:1s" alt="æ¼¢å ¡ç¥å·" title="æ¼¢å ¡ç¥å·">
    <img src="img/rocket_cat1.jpg" class="floating" style="animation-delay:1.5s" alt="ç«ç®­è²“" title="ç«ç®­è²“">
    <img src="img/fries2.jpg" class="floating" style="animation-delay:2s" alt="è–¯æ¢å¯¶å¯¶" title="è–¯æ¢å¯¶å¯¶">
  </div>

  <!-- äº¤æ˜“æ­·å² -->
  <div class="section-title">ğŸ“‹ äº¤æ˜“æ­·å²</div>
  <div class="history-table">
    <table>
      <thead>
        <tr>
          <th>æ™‚é–“</th>
          <th>å¹£ç¨®</th>
          <th>å‹•ä½œ</th>
          <th>å…¥å ´åƒ¹</th>
          <th>å‡ºå ´åƒ¹</th>
          <th>ç›ˆè™§</th>
          <th>è²»ç‡è¼ªæ•¸</th>
        </tr>
      </thead>
      <tbody id="historyBody">
        <tr><td colspan="7" style="text-align:center;color:#888;">è¼‰å…¥ä¸­...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="footer">
    <div class="cute-section" style="padding:10px">
      <img src="img/milkshake2.jpg" class="floating" style="width:80px;height:80px;animation-delay:0.3s" alt="å¥¶æ˜”" title="å¥¶æ˜”å¤§å“¥">
      <img src="img/hamster2.jpg" class="floating" style="width:80px;height:80px;animation-delay:0.8s" alt="å€‰é¼ " title="å€‰é¼ å¯¶å¯¶">
      <img src="img/rocket_cat2.jpg" class="floating" style="width:80px;height:80px;animation-delay:1.3s" alt="ç«ç®­è²“" title="ç«ç®­è²“">
    </div>
    <p>ğŸ” ç”¨æ„›èˆ‡æ¼”ç®—æ³•è£½ä½œ <span class="love">â¤ï¸</span> çµ¦æœ€å¯æ„›çš„å¯¶è² ğŸŸ</p>
    <p style="margin-top:5px;">è‡ªå‹•æ›´æ–°æ¯ 5 åˆ†é˜ | è³‡æ–™åƒ…ä¾›åƒè€ƒ</p>
    <p style="margin-top:5px;font-size:0.75em;">ğŸŸ Ba da ba ba ba~ I'm lovin' it ğŸ’•</p>
  </div>
</div>

<script>
const DATA_URL = 'data.json';
const REFRESH_MS = 60 * 1000; // æ¯åˆ†é˜åˆ·æ–°

function formatTime(ts) {
  if (!ts) return '--';
  const d = new Date(ts);
  return d.toLocaleString('zh-TW', { timeZone: 'Asia/Taipei', hour12: false });
}

function formatUSD(n) {
  const v = parseFloat(n) || 0;
  return (v >= 0 ? '+' : '') + '$' + v.toFixed(2);
}

function getNextSettlement() {
  const now = new Date();
  const hours = [0, 8, 16];
  for (const h of hours) {
    const target = new Date(now);
    target.setUTCHours(h, 0, 0, 0);
    if (target > now) {
      const diff = Math.floor((target - now) / 60000);
      return `${Math.floor(diff/60)}h ${diff%60}m`;
    }
  }
  const tomorrow = new Date(now);
  tomorrow.setUTCDate(tomorrow.getUTCDate() + 1);
  tomorrow.setUTCHours(0, 0, 0, 0);
  const diff = Math.floor((tomorrow - now) / 60000);
  return `${Math.floor(diff/60)}h ${diff%60}m`;
}

function renderPositions(positions) {
  const grid = document.getElementById('positionsGrid');
  if (!positions || positions.length === 0) {
    grid.innerHTML = '<div class="position-card"><p style="text-align:center;color:#888;">ğŸŸ ç›®å‰æ²’æœ‰æŒå€‰ï¼Œç­‰å¾…æ©Ÿæœƒä¸­...</p></div>';
    return;
  }
  grid.innerHTML = positions.map(p => {
    const pnl = parseFloat(p.unrealizedPnl) || 0;
    const pnlClass = pnl >= 0 ? 'profit' : 'loss';
    const barClass = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
    const barWidth = Math.min(Math.abs(pnl) / 5 * 100, 100);
    return `
      <div class="position-card">
        <div class="symbol">${p.symbol} ${pnl >= 0 ? 'ğŸŸ¢' : 'ğŸ”´'}</div>
        <div class="details">
          <span class="detail-label">å…¥å ´åƒ¹</span><span class="detail-value">$${parseFloat(p.entryPrice).toFixed(4)}</span>
          <span class="detail-label">ç•¶å‰åƒ¹</span><span class="detail-value">$${parseFloat(p.markPrice || 0).toFixed(4)}</span>
          <span class="detail-label">æ•¸é‡</span><span class="detail-value">${p.qty}</span>
          <span class="detail-label">æ§“æ¡¿</span><span class="detail-value">${p.leverage}x</span>
          <span class="detail-label">è²»ç‡</span><span class="detail-value">${parseFloat(p.fundingRate).toFixed(4)}%</span>
          <span class="detail-label">ç›ˆè™§</span><span class="detail-value ${pnlClass}">${formatUSD(pnl)}</span>
          <span class="detail-label">çµç®—è¼ªæ•¸</span><span class="detail-value">${p.settlementsCollected}/${p.targetRounds || 3}</span>
          <span class="detail-label">é–‹å€‰æ™‚é–“</span><span class="detail-value">${formatTime(p.openTime)}</span>
        </div>
        <div class="pnl-bar"><div class="pnl-fill ${barClass}" style="width:${barWidth}%"></div></div>
      </div>`;
  }).join('');
}

function renderHistory(history) {
  const tbody = document.getElementById('historyBody');
  if (!history || history.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#888;">ğŸ” é‚„æ²’æœ‰äº¤æ˜“ç´€éŒ„</td></tr>';
    return;
  }
  tbody.innerHTML = history.slice(0, 50).map(h => {
    const pnl = parseFloat(h.pnl) || 0;
    const pnlClass = pnl >= 0 ? 'profit' : 'loss';
    const icon = h.action === 'STOP_LOSS' ? 'ğŸ›‘' : h.action === 'OPEN' ? 'ğŸ¯' : 'ğŸ“¤';
    return `<tr>
      <td>${formatTime(h.time)}</td>
      <td><strong>${h.symbol}</strong></td>
      <td>${icon} ${h.action}</td>
      <td>$${parseFloat(h.entryPrice || 0).toFixed(4)}</td>
      <td>$${parseFloat(h.exitPrice || 0).toFixed(4)}</td>
      <td class="${pnlClass}"><strong>${formatUSD(pnl)}</strong></td>
      <td>${h.rounds || '--'}</td>
    </tr>`;
  }).join('');
}

async function loadData() {
  try {
    const res = await fetch(DATA_URL + '?t=' + Date.now());
    const data = await res.json();

    // ç¸½è¦½
    const totalPnl = parseFloat(data.totalProfit) || 0;
    document.getElementById('totalPnl').textContent = formatUSD(totalPnl);
    document.getElementById('totalPnl').className = 'value ' + (totalPnl >= 0 ? 'profit' : 'loss');

    document.getElementById('posCount').textContent = `${(data.positions || []).length}/${data.maxPositions || 3}`;
    document.getElementById('tradeCount').textContent = data.tradeCount || 0;
    document.getElementById('winRate').textContent = data.winRate ? data.winRate + '%' : '--%';
    document.getElementById('balance').textContent = '$' + (parseFloat(data.balance) || 0).toFixed(2);

    const unrealized = (data.positions || []).reduce((s, p) => s + (parseFloat(p.unrealizedPnl) || 0), 0);
    document.getElementById('unrealizedPnl').textContent = formatUSD(unrealized);
    document.getElementById('unrealizedPnl').className = 'value ' + (unrealized >= 0 ? 'profit' : 'loss');

    document.getElementById('lastUpdate').textContent = formatTime(data.lastUpdate);
    document.getElementById('nextSettlement').textContent = getNextSettlement();

    // ç³»çµ±ç‹€æ…‹
    const age = Date.now() - (data.lastUpdate || 0);
    const online = age < 10 * 60 * 1000;
    document.getElementById('statusDot').className = 'status-dot ' + (online ? 'dot-green' : 'dot-red');
    document.getElementById('statusText').textContent = online ? 'ç³»çµ±é‹è¡Œä¸­ ğŸŸ' : 'ç³»çµ±é›¢ç·š âš ï¸';

    renderPositions(data.positions || []);
    renderHistory(data.history || []);
  } catch (e) {
    console.error('è¼‰å…¥å¤±æ•—:', e);
  }
}

loadData();
setInterval(loadData, REFRESH_MS);
setInterval(() => {
  document.getElementById('nextSettlement').textContent = getNextSettlement();
}, 60000);
</script>
</body>
</html>
